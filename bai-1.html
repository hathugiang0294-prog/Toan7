<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B√†i 1: T·∫≠p h·ª£p c√°c s·ªë h·ªØu t·ªâ - K·∫øt n·ªëi tri th·ª©c</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    <script>
        window.MathJax = {
            tex: { 
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script" async></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body { font-family: 'Comfortaa', cursive; scroll-behavior: smooth; }
        .mjx-container { max-width: 100% !important; overflow-x: auto !important; }
        
        nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .section-dashed {
            border: 3px dashed #cbd5e1;
            border-radius: 24px;
            transition: border-color 0.3s;
        }
        .section-dashed:hover { border-color: #3b82f6; }

        .check-btn { transition: all 0.2s; cursor: pointer; -webkit-tap-highlight-color: transparent; border: 2px solid #e2e8f0; }
        .selected-true { background-color: #22c55e !important; color: white !important; border-color: #16a34a !important; }
        .selected-false { background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
        .correct-highlight { border: 3px solid #22c55e !important; box-shadow: 0 0 8px rgba(34, 197, 94, 0.4); }
        
        .mcq-option { border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s; border-radius: 16px; }
        .mcq-option.selected { border-color: #3b82f6; background-color: #eff6ff; }
        .mcq-option.correct { border-color: #22c55e; background-color: #dcfce7; color: #166534; }
        .mcq-option.wrong { border-color: #ef4444; background-color: #fee2e2; color: #991b1b; }
        
        .fill-input { border-bottom: 2px dashed #3b82f6; outline: none; text-align: center; width: 120px; font-weight: bold; color: #2563eb; background: transparent; }
        .fill-correct { background-color: #dcfce7; border-color: #22c55e; border-style: solid; }
        .fill-wrong { background-color: #fee2e2; border-color: #ef4444; border-style: solid; }
        
        .feedback-box { display: none; margin-top: 0.5rem; padding: 0.75rem; border-radius: 0.75rem; border-left: 4px solid #ef4444; background-color: #fffafb; font-size: 0.85rem; line-height: 1.4; }
        .is-submitted .feedback-box { display: block; }

        .hint-box { display: none; margin-top: 0.5rem; padding: 0.75rem; border-radius: 0.75rem; border: 1px dashed #eab308; background-color: #fefce8; color: #854d0e; font-size: 0.85rem; }

        .btn-download { background-color: #4f46e5; color: white; padding: 6px 12px; border-radius: 99px; font-size: 0.75rem; font-weight: bold; display: flex; align-items: center; gap: 4px; transition: opacity 0.2s; }
        .btn-download:hover { opacity: 0.9; }

        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
        .loader { border: 6px solid #f3f3f3; border-top: 6px solid #3b82f6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .warmup-input-refined {
            width: 140px; padding: 10px; text-align: center; font-size: 1rem; font-weight: 700; border-radius: 15px; border: 2px solid #3b82f6; background: #f0f7ff; color: #1e40af; outline: none; transition: all 0.3s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Chatbot N√¢ng c·∫•p: Lu√¥n ƒë·ªìng h√†nh */
        #chatbot-container { 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            z-index: 2000; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.2));
        }
        #chat-window { 
            width: 380px; 
            height: 520px; 
            background: white; 
            border-radius: 24px; 
            display: none; 
            flex-direction: column; 
            overflow: hidden; 
            border: 2px solid #3b82f6; 
            margin-bottom: 15px;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        #chat-header { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 16px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: #f8fafc; scroll-behavior: smooth; }
        
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 88%; font-size: 0.95rem; line-height: 1.6; position: relative; word-wrap: break-word; }
        .msg-bot { background: white; color: #1e293b; align-self: flex-start; border: 1px solid #e2e8f0; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg-user { background: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        
        #chat-input-area { padding: 12px; background: white; border-top: 1px solid #e2e8f0; display: flex; gap: 8px; }
        #chat-input { flex: 1; border: 1px solid #cbd5e1; border-radius: 24px; padding: 8px 16px; outline: none; font-size: 0.95rem; transition: border-color 0.2s; }
        #chat-input:focus { border-color: #3b82f6; }
        
        .chat-toggle-wrapper { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .chat-label { background: #3b82f6; color: white; padding: 10px 20px; border-radius: 99px; font-weight: bold; font-size: 0.9rem; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        #chat-toggle { width: 64px; height: 64px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; transition: all 0.3s; position: relative; }
        #chat-toggle::after { content: ''; position: absolute; inset: -4px; border: 2px solid #3b82f6; border-radius: 50%; animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { transform: scale(0.9); opacity: 1; } 100% { transform: scale(1.4); opacity: 0; } }
        
        .typing { display: flex; gap: 4px; padding: 10px; }
        .dot { width: 6px; height: 6px; background: #cbd5e1; border-radius: 50%; animation: bounce 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-6px); } }

        .hint-btn { display: flex; align-items: center; gap: 4px; background: #fefce8; border: 1px solid #fde047; padding: 4px 10px; border-radius: 99px; color: #854d0e; font-size: 0.7rem; font-weight: bold; transition: all 0.2s; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24 text-slate-800">

    <nav class="p-4 shadow-sm mb-6">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <a href="#" class="flex items-center gap-2 text-orange-600 font-bold hover:opacity-80 transition-opacity">
                <span class="text-xl">üè†</span>
                <span class="hidden sm:inline">Quay v·ªÅ Trang ch·ªß</span>
                <span class="sm:hidden text-xs">Trang ch·ªß</span>
            </a>
            <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">To√°n 7 - B√†i 1</div>
        </div>
    </nav>

    <div id="loading-overlay">
        <div class="loader mb-4"></div>
        <p class="font-bold text-blue-600 animate-pulse">AI ƒêang so·∫°n b·ªô ƒë·ªÅ m·ªõi cho b·∫°n...</p>
    </div>

    <div class="max-w-4xl mx-auto px-3 md:px-6 space-y-12">
        
        <div class="text-center py-6">
            <h1 class="text-3xl md:text-4xl font-black text-blue-600 uppercase tracking-tighter flex items-center justify-center gap-3">
                <span class="edu-icon">üìê</span> B√†i 1: T·∫≠p h·ª£p c√°c s·ªë h·ªØu t·ªâ <span class="edu-icon">‚úèÔ∏è</span>
            </h1>
            <p class="text-slate-500 font-bold mt-2">S√°ch K·∫øt n·ªëi tri th·ª©c v·ªõi cu·ªôc s·ªëng - To√°n 7</p>
        </div>

        <!-- KI·∫æN TH·ª®C TR·ªåNG T√ÇM -->
        <div id="capture-knowledge" class="bg-white p-6 section-dashed shadow-sm relative">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-xl font-bold text-blue-800 flex items-center gap-2">
                    <span class="p-2 bg-blue-100 rounded-lg text-blue-600">üìñ</span>
                    Ki·∫øn Th·ª©c Tr·ªçng T√¢m (B√†i 1)
                </h2>
                <button onclick="downloadAsImage('capture-knowledge', 'Kien_Thuc_Bai_1')" class="btn-download">
                    <span>üñºÔ∏è</span> T·∫£i ·∫¢nh Ki·∫øn Th·ª©c
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div class="bg-blue-50/50 p-5 rounded-2xl border border-blue-100 space-y-3 shadow-inner">
                    <h3 class="font-bold text-blue-700">1. Kh√°i ni·ªám s·ªë h·ªØu t·ªâ</h3>
                    <ul class="space-y-2 text-slate-600">
                        <li>‚Ä¢ S·ªë vi·∫øt ƒë∆∞·ª£c d∆∞·ªõi d·∫°ng $\frac{a}{b}$ ($a, b \in \mathbb{Z}, b \neq 0$).</li>
                        <li>‚Ä¢ T·∫≠p h·ª£p k√Ω hi·ªáu l√† $\mathbb{Q}$.</li>
                    </ul>
                </div>
                <div class="bg-green-50/50 p-5 rounded-2xl border border-green-100 space-y-3 shadow-inner">
                    <h3 class="font-bold text-green-700">2. Th·ª© t·ª± v√† Tr·ª•c s·ªë</h3>
                    <ul class="space-y-2 text-slate-600">
                        <li>‚Ä¢ M·ªçi s·ªë h·ªØu t·ªâ ƒë·ªÅu c√≥ ƒëi·ªÉm bi·ªÉu di·ªÖn tr√™n tr·ª•c s·ªë.</li>
                        <li>‚Ä¢ S·ªë ƒë·ªëi c·ªßa $a$ l√† $-a$. T·ªïng hai s·ªë ƒë·ªëi b·∫±ng 0.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- PH√Å BƒÇNG -->
        <div id="warmup-section" class="bg-white p-8 section-dashed border-blue-200 shadow-md relative overflow-hidden">
            <div id="warmup-task">
                <h2 class="text-2xl font-black text-blue-600 flex items-center gap-3 mb-4">
                    <span class="text-3xl">üßä</span> NHI·ªÜM V·ª§ PH√Å BƒÇNG
                </h2>
                <p class="text-slate-600 mb-6 font-medium">Gi·∫£i m√£ c√¢u ƒë·ªë sau ƒë·ªÉ m·ªü kh√≥a <strong>H·ªôp Qu√† May M·∫Øn</strong>:</p>
                <div class="bg-blue-50 p-6 rounded-3xl border-2 border-blue-100 mb-6">
                    <p class="text-lg font-bold text-blue-800 text-center">
                        "T√¥i l√† m·ªôt s·ªë h·ªØu t·ªâ. T√¥i kh√¥ng d∆∞∆°ng, c≈©ng kh√¥ng √¢m. <br>ƒê·ªë b·∫°n t√¥i l√† s·ªë m·∫•y?"
                    </p>
                    <div class="mt-6 flex flex-col items-center gap-4">
                        <input type="text" id="warmup-input" placeholder="Nh·∫≠p s·ªë t·∫°i ƒë√¢y" class="warmup-input-refined">
                        <button onclick="unlockGift()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-8 rounded-xl transition-all shadow-lg active:scale-95 text-sm uppercase tracking-wider">
                            GI·∫¢I M√É üöÄ
                        </button>
                    </div>
                </div>
            </div>
            <div id="gift-section" class="hidden flex flex-col items-center text-center animate-bounce-in">
                <div class="text-7xl mb-4 gift-box cursor-pointer" onclick="openGift()">üéÅ</div>
                <h3 class="text-xl font-bold text-orange-600">B·∫†N ƒê√É M·ªû KH√ìA TH√ÄNH C√îNG!</h3>
            </div>
            <div id="reward-content" class="hidden text-center space-y-4 py-4">
                <h3 class="text-2xl font-black text-green-600 uppercase">Ch√∫c m·ª´ng S·ª© Gi·∫£ To√°n H·ªçc!</h3>
                <p class="text-blue-600 font-bold animate-pulse mt-4">S·∫µn s√†ng chinh ph·ª•c c√°c th·ª≠ th√°ch b√™n d∆∞·ªõi nh√©! üëá</p>
            </div>
        </div>

        <!-- PH·∫¶N 1: MCQ -->
        <div id="capture-mcq" class="bg-white p-6 section-dashed shadow-sm">
            <div class="flex justify-between items-center mb-8 border-l-4 border-blue-600 pl-3">
                <h2 class="text-xl font-bold text-blue-800 uppercase">üìù PH·∫¶N 1: Tr·∫Øc nghi·ªám (15 c√¢u)</h2>
                <button onclick="downloadAsImage('capture-mcq', 'De_Trac_Nghiem_Bai_1')" class="btn-download">üñºÔ∏è T·∫£i ·∫¢nh ƒê·ªÅ</button>
            </div>
            <div id="mcq-container" class="space-y-8"></div>
        </div>

        <!-- PH·∫¶N 2: T/F -->
        <div id="capture-tf" class="bg-white p-6 section-dashed shadow-sm">
            <div class="flex justify-between items-center mb-8 border-l-4 border-blue-600 pl-3">
                <h2 class="text-xl font-bold text-blue-800 uppercase">‚úîÔ∏è PH·∫¶N 2: ƒê√∫ng/Sai (5 c√¢u)</h2>
                <button onclick="downloadAsImage('capture-tf', 'De_Dung_Sai_Bai_1')" class="btn-download">üñºÔ∏è T·∫£i ·∫¢nh ƒê·ªÅ</button>
            </div>
            <div id="tf-container" class="space-y-10"></div>
        </div>

        <!-- PH·∫¶N 3: FILL -->
        <div id="capture-fill" class="bg-white p-6 section-dashed shadow-sm">
            <div class="flex justify-between items-center mb-8 border-l-4 border-blue-600 pl-3">
                <h2 class="text-xl font-bold text-blue-800 uppercase">üñãÔ∏è PH·∫¶N 3: Tr·∫£ l·ªùi ng·∫Øn (5 c√¢u)</h2>
                <button onclick="downloadAsImage('capture-fill', 'De_Tra_Loi_Ngan_Bai_1')" class="btn-download">üñºÔ∏è T·∫£i ·∫¢nh ƒê·ªÅ</button>
            </div>
            <div id="fill-container" class="space-y-6"></div>
        </div>

        <div class="text-center py-12">
            <button id="submit-btn" onclick="checkResults()" class="bg-blue-600 hover:bg-blue-700 text-white font-black py-5 px-16 rounded-full shadow-2xl transition-all active:scale-95 text-xl tracking-widest flex items-center gap-4 mx-auto">
                <span>üì§</span> N·ªòP B√ÄI KI·ªÇM TRA
            </button>
            <div id="result-board" class="mt-8 hidden">
                <div class="bg-white section-dashed p-8 inline-block shadow-xl w-full max-w-2xl">
                    <div id="score-text" class="text-4xl font-black text-blue-700 mb-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- CHATBOT ƒê·ªíNG H√ÄNH N√ÇNG C·∫§P TO√ÅN H·ªåC -->
    <div id="chatbot-container">
        <div id="chat-window">
            <div id="chat-header">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></span>
                    <span>Ng∆∞·ªùi B·∫°n ƒê·ªìng H√†nh üë©‚Äçüè´</span>
                </div>
                <button onclick="toggleChat()" class="text-white hover:rotate-90 transition-transform">‚úï</button>
            </div>
            <div id="chat-messages">
                <div class="msg msg-bot">Ch√†o b·∫°n! M√¨nh l√† <b>Ng∆∞·ªùi B·∫°n ƒê·ªìng H√†nh</b>. M√¨nh s·∫Ω gi√∫p b·∫°n gi·∫£i ƒë√°p c√°c v·∫•n ƒë·ªÅ v·ªÅ S·ªë h·ªØu t·ªâ ($\mathbb{Q}$) m·ªôt c√°ch chu·∫©n x√°c nh·∫•t. B·∫°n c·∫ßn m√¨nh h·ªó tr·ª£ g√¨ kh√¥ng?</div>
            </div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="Nh·∫≠p c√¢u h·ªèi to√°n h·ªçc c·ªßa b·∫°n..." onkeypress="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()" class="bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-md hover:bg-blue-700">G·ª≠i</button>
            </div>
        </div>
        <div class="chat-toggle-wrapper" onclick="toggleChat()">
            <div class="chat-label">H·ªèi ƒë√°p To√°n AI üí¨</div>
            <div id="chat-toggle">üí°</div>
        </div>
    </div>

    <script>
        const apiKey = ""; 

        const ORIGINAL_MCQ = [
            { l: "nb", q: "T·∫≠p h·ª£p c√°c s·ªë h·ªØu t·ªâ ƒë∆∞·ª£c k√Ω hi·ªáu l√†:", options: ["$\\mathbb{N}$", "$\\mathbb{Z}$", "$\\mathbb{Q}$", "$\\mathbb{R}$"], correct: 2, exp: "S·ªë h·ªØu t·ªâ k√Ω hi·ªáu l√† $\\mathbb{Q}$.", hint: "S·ªë h·ªØu t·ªâ b·∫Øt ƒë·∫ßu b·∫±ng ch·ªØ Q (Quotient)." },
            { l: "nb", q: "S·ªë ƒë·ªëi c·ªßa s·ªë $-\\frac{5}{6}$ l√†:", options: ["$\\frac{5}{6}$", "$\\frac{6}{5}$", "$-\\frac{6}{5}$", "$0$"], correct: 0, exp: "S·ªë ƒë·ªëi c·ªßa $-a$ l√† $a$.", hint: "S·ªë ƒë·ªëi ch·ªâ kh√°c nhau v·ªÅ d·∫•u." },
            { l: "nb", q: "S·ªë n√†o sau ƒë√¢y l√† s·ªë h·ªØu t·ªâ d∆∞∆°ng?", options: ["$-2$", "$0$", "$\\frac{-1}{-3}$", "$\\frac{2}{-5}$"], correct: 2, exp: "$\\frac{-1}{-3} = \\frac{1}{3} > 0$.", hint: "S·ªë h·ªØu t·ªâ d∆∞∆°ng l√† s·ªë l·ªõn h∆°n 0. L∆∞u √Ω √¢m chia √¢m b·∫±ng d∆∞∆°ng." },
            { l: "nb", q: "M·ªçi s·ªë nguy√™n $a$ ƒë·ªÅu c√≥ th·ªÉ vi·∫øt d∆∞·ªõi d·∫°ng:", options: ["$\\frac{a}{1}$", "$\\frac{1}{a}$", "$\\frac{a}{a}$", "$\\frac{0}{a}$"], correct: 0, exp: "$a = a/1$.", hint: "B·∫•t k·ª≥ s·ªë n√†o chia cho 1 c≈©ng b·∫±ng ch√≠nh n√≥." },
            { l: "nb", q: "Kh·∫≥ng ƒë·ªãnh n√†o sau ƒë√¢y l√† ƒê√öNG?", options: ["$\\mathbb{Q} \\subset \\mathbb{Z}$", "$\\mathbb{Z} \\subset \\mathbb{Q}$", "$\\mathbb{Q} \\subset \\mathbb{N}$", "$\\mathbb{N} \\subset \\mathbb{Z}$ l√† sai"], correct: 1, exp: "S·ªë nguy√™n l√† con s·ªë h·ªØu t·ªâ.", hint: "S·ªë t·ª± nhi√™n $\\subset$ s·ªë nguy√™n $\\subset$ s·ªë h·ªØu t·ªâ." },
            { l: "nb", q: "S·ªë th·∫≠p ph√¢n $0,25$ vi·∫øt d∆∞·ªõi d·∫°ng ph√¢n s·ªë t·ªëi gi·∫£n l√†:", options: ["$\\frac{25}{100}$", "$\\frac{1}{4}$", "$\\frac{2}{5}$", "$\\frac{1}{2}$"], correct: 1, exp: "$0,25 = 1/4$.", hint: "ƒê·ªïi 0,25 ra 25/100 r·ªìi r√∫t g·ªçn." },
            { l: "th", q: "S·ªë h·ªØu t·ªâ n√†o sau ƒë√¢y n·∫±m b√™n tr√°i ƒëi·ªÉm $0$ tr√™n tr·ª•c s·ªë?", options: ["$1,5$", "$\\frac{3}{4}$", "$-\\frac{2}{3}$", "$2$"], correct: 2, exp: "S·ªë h·ªØu t·ªâ √¢m n·∫±m b√™n tr√°i ƒëi·ªÉm 0.", hint: "S·ªë n·∫±m b√™n tr√°i ƒëi·ªÉm 0 l√† s·ªë √¢m." },
            { l: "th", q: "K·∫øt qu·∫£ so s√°nh hai s·ªë $-0,5$ v√† $\\frac{1}{4}$ l√†:", options: ["$-0,5 > \\frac{1}{4}$", "$-0,5 < \\frac{1}{4}$", "$-0,5 = \\frac{1}{4}$", "Kh√¥ng so s√°nh"], correct: 1, exp: "S·ªë √¢m lu√¥n nh·ªè h∆°n s·ªë d∆∞∆°ng.", hint: "So s√°nh m·ªôt s·ªë √¢m v√† m·ªôt s·ªë d∆∞∆°ng." },
            { l: "th", q: "S·ªë ƒë·ªëi c·ªßa h·ªón s·ªë $1\\frac{1}{2}$ l√†:", options: ["$-1,5$", "$\\frac{3}{2}$", "$-1\\frac{2}{1}$", "$1,5$"], correct: 0, exp: "$1,5$ c√≥ s·ªë ƒë·ªëi l√† $-1,5$.", hint: "ƒê·ªïi h·ªón s·ªë ra s·ªë th·∫≠p ph√¢n ho·∫∑c ph√¢n s·ªë r·ªìi th√™m d·∫•u tr·ª´." },
            { l: "th", q: "ƒêi·ªÉm $M$ tr√™n tr·ª•c s·ªë bi·ªÉu di·ªÖn s·ªë $\\frac{3}{4}$. Kho·∫£ng c√°ch t·ª´ $M$ ƒë·∫øn g·ªëc $O$ l√†:", options: ["$3$ ƒë∆°n v·ªã", "$4$ ƒë∆°n v·ªã", "$\\frac{3}{4}$ ƒë∆°n v·ªã", "$0,34$ ƒë∆°n v·ªã"], correct: 2, exp: "Kho·∫£ng c√°ch l√† tr·ªã tuy·ªát ƒë·ªëi.", hint: "Kho·∫£ng c√°ch t·ª´ m·ªôt ƒëi·ªÉm ƒë·∫øn O ch√≠nh l√† gi√° tr·ªã tuy·ªát ƒë·ªëi c·ªßa s·ªë ƒë√≥." },
            { l: "th", q: "S·∫Øp x·∫øp tƒÉng d·∫ßn: $0; -1; \\frac{1}{2}$ l√†:", options: ["$0; -1; \\frac{1}{2}$", "$-1; 0; \\frac{1}{2}$", "$\\frac{1}{2}; 0; -1$", "$-1; \\frac{1}{2}; 0$"], correct: 1, exp: "$-1 < 0 < 0,5$.", hint: "S·ªë √¢m < 0 < s·ªë d∆∞∆°ng." },
            { l: "vd", q: "S·ªë h·ªØu t·ªâ $x$ n·∫±m gi·ªØa $-1$ v√† $0$ l√†:", options: ["$\\frac{1}{2}$", "$-\\frac{3}{2}$", "$-\\frac{1}{4}$", "$-1,2$"], correct: 2, exp: "$-1 < -0,25 < 0$.", hint: "T√¨m s·ªë √¢m nh∆∞ng c√≥ gi√° tr·ªã tuy·ªát ƒë·ªëi nh·ªè h∆°n 1." },
            { l: "vd", q: "Tr√™n tr·ª•c s·ªë, ƒëi·ªÉm bi·ªÉu di·ªÖn $-2/3$ v√† $2/3$ c√≥ ƒë·∫∑c ƒëi·ªÉm:", options: ["C√πng ph√≠a O", "C√πng b√™n ph·∫£i", "ƒê·ªëi x·ª©ng qua O", "Tr√πng nhau"], correct: 2, exp: "Hai s·ªë ƒë·ªëi nhau ƒë·ªëi x·ª©ng qua g·ªëc O.", hint: "Hai s·ªë ƒë·ªëi nhau tr√™n tr·ª•c s·ªë n·∫±m v·ªÅ hai ph√≠a c·ªßa O." },
            { l: "vd", q: "Trong c√°c ph√¢n s·ªë $\\frac{2}{3}; \\frac{4}{6}; \\frac{-2}{-3}; \\frac{6}{9}$, c√≥ bao nhi√™u s·ªë h·ªØu t·ªâ kh√°c nhau?", options: ["1", "2", "3", "4"], correct: 0, exp: "C·∫£ 4 ph√¢n s·ªë ƒë·ªÅu b·∫±ng $2/3$ n√™n ch·ªâ l√† 1 s·ªë h·ªØu t·ªâ.", hint: "H√£y r√∫t g·ªçn t·∫•t c·∫£ c√°c ph√¢n s·ªë v·ªÅ t·ªëi gi·∫£n." },
            { l: "vd", q: "Cho $x = \\frac{a}{b}$. N·∫øu $a, b$ c√πng d·∫•u th√¨ $x$ l√†:", options: ["S·ªë h·ªØu t·ªâ d∆∞∆°ng", "S·ªë h·ªØu t·ªâ √¢m", "S·ªë 0", "Kh√¥ng x√°c ƒë·ªãnh"], correct: 0, exp: "C√πng d·∫•u th√¨ th∆∞∆°ng d∆∞∆°ng.", hint: "Quy t·∫Øc d·∫•u c·ªßa ph√©p chia gi·ªëng ph√©p nh√¢n: (+) : (+) = (+) v√† (-) : (-) = (+)." }
        ];

        const ORIGINAL_TF = [
            { q: "C√¢u 1: V·ªÅ kh√°i ni·ªám s·ªë h·ªØu t·ªâ", items: [
                { t: "a) S·ªë t·ª± nhi√™n l√† s·ªë h·ªØu t·ªâ.", a: true, exp: "$n = n/1$.", h: "M·ªçi s·ªë t·ª± nhi√™n ƒë·ªÅu vi·∫øt ƒë∆∞·ª£c d∆∞·ªõi d·∫°ng ph√¢n s·ªë n/1." },
                { t: "b) S·ªë 0 l√† s·ªë h·ªØu t·ªâ d∆∞∆°ng.", a: false, exp: "S·ªë 0 kh√¥ng √¢m kh√¥ng d∆∞∆°ng.", h: "S·ªë 0 l√† s·ªë ƒë·∫∑c bi·ªát." },
                { t: "c) $-1,5$ l√† s·ªë h·ªØu t·ªâ.", a: true, exp: "$-1,5 = -3/2$.", h: "S·ªë th·∫≠p ph√¢n h·ªØu h·∫°n ƒë·ªÅu l√† s·ªë h·ªØu t·ªâ." },
                { t: "d) T·∫≠p s·ªë h·ªØu t·ªâ k√Ω hi·ªáu l√† $\\mathbb{Q}$.", a: true, exp: "ƒê√∫ng.", h: "Xem l·∫°i ph·∫ßn k√Ω hi·ªáu t·∫≠p h·ª£p." }
            ]},
            { q: "C√¢u 2: V·ªÅ tr·ª•c s·ªë v√† s·ªë ƒë·ªëi", items: [
                { t: "a) $-2$ n·∫±m b√™n tr√°i $-3$ tr√™n tr·ª•c s·ªë.", a: false, exp: "$-2 > -3$ n√™n n·∫±m b√™n ph·∫£i.", h: "S·ªë l·ªõn h∆°n n·∫±m b√™n ph·∫£i." },
                { t: "b) G·ªëc $O$ n·∫±m gi·ªØa s·ªë √¢m v√† s·ªë d∆∞∆°ng.", a: true, exp: "ƒê√∫ng.", h: "Tr·ª•c s·ªë ph√¢n chia b·ªüi s·ªë 0." },
                { t: "c) Kho·∫£ng c√°ch t·ª´ g·ªëc $O$ ƒë·∫øn ƒëi·ªÉm bi·ªÉu di·ªÖn s·ªë $1$ l√† $1$.", a: true, exp: "ƒê√∫ng.", h: "ƒê·ªãnh nghƒ©a v·ªÅ ƒë∆°n v·ªã tr√™n tr·ª•c s·ªë." },
                { t: "d) Hai s·ªë ƒë·ªëi c√°ch ƒë·ªÅu ƒëi·ªÉm $O$.", a: true, exp: "ƒê√∫ng.", h: "T√≠nh ch·∫•t c·ªßa hai s·ªë ƒë·ªëi." }
            ]},
            { q: "C√¢u 3: V·ªÅ so s√°nh s·ªë h·ªØu t·ªâ", items: [
                { t: "a) $-0,75 = -\\frac{3}{4}$.", a: true, exp: "ƒê√∫ng.", h: "ƒê·ªïi -0,75 ra ph√¢n s·ªë." },
                { t: "b) $\\frac{1}{2} < \\frac{1}{3}$.", a: false, exp: "Sai, $0,5 > 0,33$.", h: "Quy ƒë·ªìng m·∫´u s·ªë ho·∫∑c ƒë·ªïi ra s·ªë th·∫≠p ph√¢n." },
                { t: "c) S·ªë h·ªØu t·ªâ d∆∞∆°ng lu√¥n l·ªõn h∆°n s·ªë h·ªØu t·ªâ √¢m.", a: true, exp: "ƒê√∫ng.", h: "So s√°nh d·∫•u." },
                { t: "d) S·ªë h·ªØu t·ªâ √¢m l·ªõn h∆°n $0$.", a: false, exp: "S·ªë h·ªØu t·ªâ √¢m lu√¥n nh·ªè h∆°n 0.", h: "ƒê·ªãnh nghƒ©a s·ªë √¢m." }
            ]},
            { q: "C√¢u 4: V·ªÅ bi·ªÉu di·ªÖn tr√™n tr·ª•c s·ªë", items: [
                { t: "a) M·ªói s·ªë h·ªØu t·ªâ ch·ªâ c√≥ 1 ƒëi·ªÉm bi·ªÉu di·ªÖn duy nh·∫•t.", a: true, exp: "M·ªói s·ªë t∆∞∆°ng ·ª©ng duy nh·∫•t 1 ƒëi·ªÉm.", h: "Nguy√™n t·∫Øc bi·ªÉu di·ªÖn s·ªë tr√™n tr·ª•c s·ªë." },
                { t: "b) ƒêi·ªÉm $\\frac{1}{2}$ n·∫±m ch√≠nh gi·ªØa $0$ v√† $1$.", a: true, exp: "ƒê√∫ng.", h: "1/2 l√† trung ƒëi·ªÉm." },
                { t: "c) ƒêi·ªÉm $-1$ c√°ch $O$ m·ªôt kho·∫£ng l√† $-1$.", a: false, exp: "Kho·∫£ng c√°ch ph·∫£i d∆∞∆°ng (b·∫±ng 1).", h: "Kho·∫£ng c√°ch kh√¥ng bao gi·ªù √¢m." },
                { t: "d) Tr·ª•c s·ªë n·∫±m ngang c√≥ chi·ªÅu d∆∞∆°ng t·ª´ tr√°i sang ph·∫£i.", a: true, exp: "Quy ∆∞·ªõc chu·∫©n.", h: "Xem l·∫°i quy ∆∞·ªõc tr·ª•c s·ªë." }
            ]},
            { q: "C√¢u 5: V·ªÅ s·ªë ƒë·ªëi n√¢ng cao", items: [
                { t: "a) S·ªë ƒë·ªëi c·ªßa s·ªë $0$ l√† ch√≠nh n√≥.", a: true, exp: "$-0 = 0$.", h: "S·ªë ƒë·∫∑c bi·ªát 0." },
                { t: "b) S·ªë ƒë·ªëi c·ªßa s·ªë ƒë·ªëi c·ªßa s·ªë h·ªØu t·ªâ $a$ l√† ch√≠nh n√≥.", a: true, exp: "$-(-a) = a$.", h: "Ph√©p nh√¢n d·∫•u: tr·ª´ c·ªßa tr·ª´ th√†nh c·ªông." },
                { t: "c) Hai s·ªë ƒë·ªëi nhau lu√¥n c√≥ t·ªïng b·∫±ng $1$.", a: false, exp: "T·ªïng lu√¥n b·∫±ng 0.", h: "ƒê·∫∑c ƒëi·ªÉm t·ªïng hai s·ªë ƒë·ªëi." },
                { t: "d) S·ªë ƒë·ªëi c·ªßa m·ªôt s·ªë h·ªØu t·ªâ d∆∞∆°ng l√† m·ªôt s·ªë d∆∞∆°ng.", a: false, exp: "S·ªë ƒë·ªëi c·ªßa s·ªë d∆∞∆°ng l√† s·ªë √¢m.", h: "ƒê·ªïi d·∫•u." }
            ]}
        ];

        const ORIGINAL_FILL = [
            { q: "S·ªë ƒë·ªëi c·ªßa s·ªë $2,5$ l√†:", a: "-2,5", exp: "ƒê·ªïi d·∫•u s·ªë h·ªØu t·ªâ.", hint: "Ch·ªâ c·∫ßn th√™m d·∫•u tr·ª´ v√†o tr∆∞·ªõc 2,5." },
            { q: "S·ªë h·ªØu t·ªâ kh√¥ng d∆∞∆°ng c≈©ng kh√¥ng √¢m l√† s·ªë:", a: "0", exp: "ƒê√≥ l√† s·ªë 0.", hint: "S·ªë duy nh·∫•t ƒë·∫∑c bi·ªát n√†y l√†..." },
            { q: "Vi·∫øt $-0,6$ d∆∞·ªõi d·∫°ng ph√¢n s·ªë t·ªëi gi·∫£n l√†:", a: "-3/5", exp: "$-6/10 = -3/5$.", hint: "ƒê·ªïi ra -6/10 r·ªìi chia c·∫£ t·ª≠ v√† m·∫´u cho 2." },
            { q: "ƒêi·ªÉm bi·ªÉu di·ªÖn s·ªë $-\\frac{1}{2}$ c√°ch g·ªëc $O$ bao nhi√™u ƒë∆°n v·ªã?", a: "0,5", exp: "Kho·∫£ng c√°ch $|-1/2| = 0,5$.", hint: "L·∫•y tr·ªã tuy·ªát ƒë·ªëi c·ªßa s·ªë ƒë√≥." },
            { q: "T·∫≠p h·ª£p c√°c s·ªë h·ªØu t·ªâ ƒë∆∞·ª£c k√Ω hi·ªáu b·∫±ng ch·ªØ c√°i n√†o?", a: "Q", exp: "K√Ω hi·ªáu l√† Q.", hint: "Ch·ªØ c√°i vi·∫øt hoa ƒë·ª©ng sau P trong b·∫£ng ch·ªØ c√°i." }
        ];

        let userMcq = Array(15).fill(null);
        let userTf = Array(5).fill(null).map(() => Array(4).fill(null));
        let isSubmitted = false;

        function init() {
            renderAll();
        }

        function toggleHint(id) {
            const el = document.getElementById(id);
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        function renderAll() {
            const mcqBox = document.getElementById('mcq-container');
            mcqBox.innerHTML = "";
            ORIGINAL_MCQ.forEach((d, i) => {
                let opts = d.options.map((o, j) => `<div onclick="setMcq(${i},${j})" id="mcq-${i}-${j}" class="mcq-option p-4 bg-white shadow-sm flex items-center mb-2"><span class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 mr-3 font-bold text-xs">${String.fromCharCode(65+j)}</span> ${o}</div>`).join('');
                mcqBox.innerHTML += `<div class="p-5 border-b relative" id="mcq-card-${i}"><button onclick="toggleHint('mcq-hint-${i}')" class="absolute right-2 top-2 hint-btn">üí° Tr·ª£ gi√∫p</button><div class="flex justify-between mb-2"><span class="font-bold text-blue-600">C√ÇU ${i+1}</span></div><p class="mb-4 text-slate-700 font-medium">${d.q}</p><div id="mcq-hint-${i}" class="hint-box">üí° G·ª£i √Ω: ${d.hint}</div><div class="grid grid-cols-1 md:grid-cols-2 gap-3">${opts}</div><div id="mcq-fb-${i}" class="feedback-box"></div></div>`;
            });

            const tfBox = document.getElementById('tf-container');
            tfBox.innerHTML = "";
            ORIGINAL_TF.forEach((d, i) => {
                let rows = d.items.map((item, j) => `<tr class="border-b"><td class="py-4 px-4 text-sm font-medium relative">${item.t}<button onclick="toggleHint('tf-hint-${i}-${j}')" class="inline-flex ml-2 text-yellow-500 text-[10px] items-center gap-1 bg-yellow-50 px-1 rounded border border-yellow-200">üí° Tr·ª£ gi√∫p</button><div id="tf-hint-${i}-${j}" class="hint-box">üí° G·ª£i √Ω: ${item.h}</div><div id="tf-fb-${i}-${j}" class="feedback-box"></div></td><td class="p-2 text-center"><button onclick="setTf(${i},${j},true)" id="tf-btn-${i}-${j}-t" class="check-btn w-10 h-10 rounded-xl border">ƒê</button></td><td class="p-2 text-center"><button onclick="setTf(${i},${j},false)" id="tf-btn-${i}-${j}-s" class="check-btn w-10 h-10 rounded-xl border">S</button></td></tr>`).join('');
                tfBox.innerHTML += `<div class="bg-slate-50 rounded-2xl border overflow-hidden mb-8"><div class="bg-white p-4 font-bold text-blue-800 border-b">${d.q}</div><table class="w-full"><tbody>${rows}</tbody></table></div>`;
            });

            const fBox = document.getElementById('fill-container');
            fBox.innerHTML = "";
            ORIGINAL_FILL.forEach((d, i) => {
                fBox.innerHTML += `<div class="bg-slate-50 p-5 rounded-2xl border space-y-2 relative"><button onclick="toggleHint('fill-hint-${i}')" class="absolute right-4 top-4 hint-btn">üí° Tr·ª£ gi√∫p</button><span><strong>C√¢u ${i+1}.</strong> ${d.q}</span><div id="fill-hint-${i}" class="hint-box">üí° G·ª£i √Ω: ${d.hint}</div><div class="flex items-center gap-4 mt-2"><input type="text" id="fill-${i}" class="fill-input"></div><div id="fill-fb-${i}" class="feedback-box"></div></div>`;
            });
            if(window.MathJax) MathJax.typeset();
        }

        async function downloadAsImage(elementId, fileName) {
            const element = document.getElementById(elementId);
            const canvas = await html2canvas(element, { scale: 2, backgroundColor: "#ffffff" });
            const link = document.createElement('a');
            link.download = fileName + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function setMcq(q, o) { 
            if(!isSubmitted) { 
                userMcq[q] = o; 
                document.getElementById(`mcq-card-${q}`).querySelectorAll('.mcq-option').forEach(opt => opt.classList.remove('selected')); 
                document.getElementById(`mcq-${q}-${o}`).classList.add('selected'); 
            } 
        }

        function setTf(q, i, v) { 
            if(!isSubmitted) { 
                userTf[q][i] = v; 
                document.getElementById(`tf-btn-${q}-${i}-t`).classList.remove('selected-true'); 
                document.getElementById(`tf-btn-${q}-${i}-s`).classList.remove('selected-false'); 
                if(v) document.getElementById(`tf-btn-${q}-${i}-t`).classList.add('selected-true'); 
                else document.getElementById(`tf-btn-${q}-${i}-s`).classList.add('selected-false'); 
            } 
        }

        function checkResults() {
            isSubmitted = true;
            let correct = 0;
            let total = ORIGINAL_MCQ.length + (ORIGINAL_TF.length * 4) + ORIGINAL_FILL.length;

            ORIGINAL_MCQ.forEach((d, i) => {
                const fb = document.getElementById(`mcq-fb-${i}`);
                const opts = document.getElementById(`mcq-card-${i}`).querySelectorAll('.mcq-option');
                opts[d.correct].classList.add('correct');
                if(userMcq[i] === d.correct) { correct++; fb.innerHTML = "‚úîÔ∏è " + d.exp; fb.className = "feedback-box block text-green-700 bg-green-50"; }
                else { if(userMcq[i] !== null) opts[userMcq[i]].classList.add('wrong'); fb.innerHTML = "‚ùå " + d.exp; fb.className = "feedback-box block text-red-700 bg-red-50"; }
            });

            ORIGINAL_TF.forEach((d, i) => { d.items.forEach((item, j) => {
                const fb = document.getElementById(`tf-fb-${i}-${j}`);
                if(userTf[i][j] === item.a) { correct++; fb.innerHTML = "‚úîÔ∏è " + item.exp; fb.className = "feedback-box block text-green-700 bg-green-50"; }
                else { fb.innerHTML = "‚ùå " + item.exp; fb.className = "feedback-box block text-red-700 bg-red-50"; }
                if(item.a) document.getElementById(`tf-btn-${i}-${j}-t`).classList.add('correct-highlight'); else document.getElementById(`tf-btn-${i}-${j}-s`).classList.add('correct-highlight');
            });});

            ORIGINAL_FILL.forEach((d, i) => {
                const input = document.getElementById(`fill-${i}`);
                const fb = document.getElementById(`fill-fb-${i}`);
                if(input.value.trim().toLowerCase() === d.a.toLowerCase()) { correct++; input.classList.add('fill-correct'); fb.innerHTML = "‚úîÔ∏è " + d.exp; fb.className = "feedback-box block text-green-700 bg-green-50"; }
                else { input.classList.add('fill-wrong'); fb.innerHTML = "‚ùå ƒê√°p √°n: " + d.a; fb.className = "feedback-box block text-red-700 bg-red-50"; }
            });

            document.getElementById('submit-btn').classList.add('hidden');
            document.getElementById('result-board').classList.remove('hidden');
            document.getElementById('score-text').innerText = `K·∫æT QU·∫¢: ${((correct/total)*10).toFixed(1)}/10`;
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
            if(window.MathJax) MathJax.typeset();
        }

        function unlockGift() {
            if(document.getElementById('warmup-input').value.trim() === "0") {
                document.getElementById('warmup-task').classList.add('hidden');
                document.getElementById('gift-section').classList.remove('hidden');
                confetti({ particleCount: 50 });
            } else alert("G·ª£i √Ω: S·ªë n√†y kh√¥ng d∆∞∆°ng c≈©ng kh√¥ng √¢m!");
        }

        function openGift() {
            document.getElementById('gift-section').classList.add('hidden');
            document.getElementById('reward-content').classList.remove('hidden');
            confetti({ particleCount: 100 });
        }

        /* CHATBOT N√ÇNG C·∫§P TO√ÅN H·ªåC */
        function toggleChat() {
            const win = document.getElementById('chat-window');
            const isVisible = win.style.display === 'flex';
            win.style.display = isVisible ? 'none' : 'flex';
            if(!isVisible) document.getElementById('chat-input').focus();
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;

            addMsg(msg, 'user');
            input.value = '';

            const typingDiv = document.createElement('div');
            typingDiv.className = 'msg msg-bot typing';
            typingDiv.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
            document.getElementById('chat-messages').appendChild(typingDiv);
            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;

            // System Instruction t·ªëi ∆∞u: Ch√≠nh x√°c c√¥ng th·ª©c v√† ƒê√∫ng tr·ªçng t√¢m
            const systemPrompt = `B·∫°n l√† "Ng∆∞·ªùi B·∫°n ƒê·ªìng H√†nh" - Gia s∆∞ To√°n l·ªõp 7 chuy√™n v·ªÅ b√†i 1: T·∫≠p h·ª£p c√°c s·ªë h·ªØu t·ªâ.
            Y√äU C·∫¶U:
            1. TR·∫¢ L·ªúI ƒê√öNG TR·ªåNG T√ÇM: Ch·ªâ gi·∫£i ƒë√°p th·∫Øc m·∫Øc li√™n quan ƒë·∫øn To√°n h·ªçc, kh√¥ng lan man sang ch·ªß ƒë·ªÅ kh√°c. 
            2. CH√çNH X√ÅC C√îNG TH·ª®C: Ph·∫£i s·ª≠ d·ª•ng c√∫ ph√°p LaTeX chu·∫©n cho m·ªçi c√¥ng th·ª©c. V√≠ d·ª•: $\\frac{a}{b}$, $a \\in \\mathbb{Z}$, $b \\neq 0$.
            3. H·ªñ TR·ª¢ B√ÄI T·∫¨P: N·∫øu h·ªçc sinh h·ªèi ƒë√°p √°n b√†i t·∫≠p tr√™n trang web, h√£y h∆∞·ªõng d·∫´n c√°ch suy lu·∫≠n thay v√¨ ƒë∆∞a ngay ƒë√°p √°n.
            4. PHONG C√ÅCH: Ng·∫Øn g·ªçn, s√∫c t√≠ch, chuy√™n nghi·ªáp nh∆∞ng v·∫´n th√¢n thi·ªán.`;

            let retries = 5;
            let delay = 1000;

            async function callGemini() {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: msg }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });
                    
                    if (!response.ok) throw new Error('API Error');
                    
                    const data = await response.json();
                    typingDiv.remove();
                    const aiMsg = data.candidates?.[0]?.content?.parts?.[0]?.text || "M√¨nh ch∆∞a hi·ªÉu √Ω b·∫°n, h√£y ƒë·∫∑t c√¢u h·ªèi c·ª• th·ªÉ h∆°n v·ªÅ S·ªë h·ªØu t·ªâ nh√©.";
                    addMsg(aiMsg, 'bot');
                } catch (e) {
                    if (retries > 0) {
                        retries--;
                        setTimeout(callGemini, delay);
                        delay *= 2;
                    } else {
                        typingDiv.remove();
                        addMsg("H·ªá th·ªëng ƒëang qu√° t·∫£i m·ªôt ch√∫t. B·∫°n h√£y th·ª≠ l·∫°i sau v√†i gi√¢y nh√©!", 'bot');
                    }
                }
            }
            callGemini();
        }

        function addMsg(text, sender) {
            const box = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `msg msg-${sender}`;
            div.innerHTML = text.replace(/\n/g, '<br>');
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            // K√≠ch ho·∫°t MathJax ƒë·ªÉ v·∫Ω l·∫°i c√¥ng th·ª©c trong tin nh·∫Øn m·ªõi
            if (window.MathJax) {
                MathJax.typesetPromise([div]).catch((err) => console.log(err));
            }
        }

        window.onload = init;
    </script>
</body>
</html>